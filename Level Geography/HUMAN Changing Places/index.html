<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Level-Up Flashcards</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b0b0b; color:#fff;
    }
    .wrap{ max-width: 980px; margin:0 auto; padding: 28px 18px 40px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      margin-bottom: 22px;
    }
    .brand{
      display:flex; align-items:center; gap:14px;
    }
    .brand img{ height:48px; width:auto; display:block; }
    .titles h1{
      margin:0; font-size:42px; letter-spacing:2px; text-transform:uppercase;
    }
    .titles .sub{
      margin-top:6px; font-size:14px; opacity:.85;
    }
    .pillrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      border:1px solid #c9a227; color:#c9a227;
      padding:8px 10px; border-radius:999px; font-size:13px;
      background: rgba(201,162,39,0.06);
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 14px 0 18px;
    }
    button{
      background:#111; color:#fff; border:1px solid #333;
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    button:hover{ border-color:#555; }
    .card{
      border:1px solid #c9a227; border-radius:18px;
      padding: 22px; min-height: 220px;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center;
      background: radial-gradient(1000px 260px at 50% 0%, rgba(201,162,39,0.10), transparent 55%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      user-select:none;
    }
    .label{ font-size:12px; letter-spacing:2px; color:#c9a227; margin-bottom:10px; }
    .text{ font-size:26px; line-height:1.25; max-width: 860px; }
    .meta{
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-top: 14px; opacity:.85; font-size:13px;
    }
    .error{
      border:1px solid #ff5a5a; background:rgba(255,90,90,0.08);
      padding:12px 14px; border-radius:12px; margin-top:14px;
      white-space:pre-wrap;
    }
    .hint{ opacity:.8; font-size:13px; margin-top:8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <!-- Optional: swap this to your logo path if you have one in the repo -->
        <!-- <img src="assets/levelup-logo.png" alt="Level-Up"> -->
        <div class="titles">
          <h1 id="mainTitle">A LEVEL GEOGRAPHY</h1>
          <div class="sub" id="subTitle">Click the card to flip. Use shuffle + reset.</div>
        </div>
      </div>
      <div class="pillrow">
        <div class="pill" id="topicPill">TOPIC: —</div>
        <div class="pill" id="countPill">CARDS: —</div>
      </div>
    </div>

    <div class="controls">
      <button id="btnPrev">◀ Prev</button>
      <button id="btnFlip">Flip</button>
      <button id="btnNext">Next ▶</button>
      <button id="btnShuffle">Shuffle</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="card" id="card">
      <div class="label" id="sideLabel">FRONT</div>
      <div class="text" id="cardText">Loading flashcards…</div>
      <div class="hint" id="hint"></div>
    </div>

    <div class="meta">
      <div id="progress">Card — of —</div>
      <div id="source">Source: —</div>
    </div>

    <div class="error" id="errorBox" style="display:none;"></div>
  </div>

<script>
  // ---- helpers ----
  const $ = (id) => document.getElementById(id);

  function getParam(name){
    const p = new URLSearchParams(location.search);
    return p.get(name);
  }

  function niceDecode(s){
    try { return decodeURIComponent(s); } catch { return s; }
  }

  function topicFromFileUrl(fileUrl){
    // Extract folder name before filename as "topic"
    // e.g. .../Level%20Geography/HUMAN%20Changing%20Places/flashcards.csv -> "HUMAN Changing Places"
    try{
      const parts = fileUrl.split("/");
      const folder = parts[parts.length - 2] || "";
      return niceDecode(folder).replace(/\+/g, " ");
    }catch{ return ""; }
  }

  function parseCSV(text){
    // Minimal CSV parser for Front,Back with quotes support
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    while(i < text.length){
      const c = text[i];
      if(c === '"'){
        if(inQuotes && text[i+1] === '"'){ field += '"'; i+=2; continue; }
        inQuotes = !inQuotes; i++; continue;
      }
      if(!inQuotes && (c === "," || c === "\n" || c === "\r")){
        if(c === ","){
          row.push(field); field=""; i++; continue;
        }
        // newline
        if(c === "\r" && text[i+1] === "\n") i++;
        row.push(field); field="";
        if(row.length >= 2 && row[0].trim() !== "Front"){
          rows.push({ front: row[0].trim(), back: row[1].trim() });
        }
        row=[]; i++; continue;
      }
      field += c; i++;
    }
    // last line
    if(field.length || row.length){
      row.push(field);
      if(row.length >= 2 && row[0].trim() !== "Front"){
        rows.push({ front: row[0].trim(), back: row[1].trim() });
      }
    }
    return rows.filter(x => x.front || x.back);
  }

  // ---- state ----
  let originalCards = [];
  let cards = [];
  let idx = 0;
  let showingFront = true;

  function showError(msg){
    $("errorBox").style.display = "block";
    $("errorBox").textContent = msg;
  }

  function updateUI(){
    if(!cards.length){
      $("cardText").textContent = "No cards loaded.";
      $("countPill").textContent = "CARDS: 0";
      $("progress").textContent = "Card — of —";
      return;
    }
    const card = cards[idx];
    $("sideLabel").textContent = showingFront ? "FRONT" : "BACK";
    $("cardText").textContent = showingFront ? card.front : card.back;
    $("progress").textContent = `Card ${idx+1} of ${cards.length}`;
    $("countPill").textContent = `CARDS: ${cards.length}`;
  }

  function flip(){ showingFront = !showingFront; updateUI(); }
  function next(){ if(!cards.length) return; idx = (idx+1) % cards.length; showingFront=true; updateUI(); }
  function prev(){ if(!cards.length) return; idx = (idx-1 + cards.length) % cards.length; showingFront=true; updateUI(); }
  function shuffle(){
    if(!cards.length) return;
    cards = [...cards].sort(() => Math.random() - 0.5);
    idx = 0; showingFront=true; updateUI();
  }
  function reset(){
    cards = [...originalCards];
    idx = 0; showingFront=true; updateUI();
  }

  // ---- wire up ----
  $("card").addEventListener("click", flip);
  $("btnFlip").addEventListener("click", flip);
  $("btnNext").addEventListener("click", next);
  $("btnPrev").addEventListener("click", prev);
  $("btnShuffle").addEventListener("click", shuffle);
  $("btnReset").addEventListener("click", reset);

  // ---- load from URL ----
  (async function init(){
    const file = getParam("file");
    const title = getParam("title"); // optional override
    if(title) $("mainTitle").textContent = niceDecode(title).toUpperCase();

    if(!file){
      $("cardText").textContent = "Missing ?file=RAW_CSV_URL in the link.";
      $("hint").textContent = "Example: ?file=https://raw.githubusercontent.com/.../flashcards.csv";
      showError("No file parameter found.\n\nAdd ?file=<raw csv url> to the end of your page URL.");
      return;
    }

    const topic = topicFromFileUrl(file);
    $("topicPill").textContent = topic ? `TOPIC: ${topic.toUpperCase()}` : "TOPIC: —";
    $("source").textContent = `Source: ${file}`;

    try{
      const res = await fetch(file, { cache: "no-store" });
      if(!res.ok) throw new Error(`Fetch failed (${res.status}) — check RAW link + file path.`);
      const text = await res.text();
      const parsed = parseCSV(text);

      if(!parsed.length){
        throw new Error("CSV loaded but no cards were found. Ensure header is Front,Back and rows are filled.");
      }

      originalCards = parsed;
      cards = [...originalCards];
      idx = 0; showingFront = true;
      $("hint").textContent = "";
      updateUI();
    }catch(err){
      $("cardText").textContent = "Could not load flashcards.";
      $("hint").textContent = "Double-check your RAW CSV link and GitHub Pages setup.";
      showError(String(err));
    }
  })();
</script>
</body>
</html>
